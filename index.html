<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>FoodRoulette</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style type="text/css">
            body{ background-color: #eee; }
            ul{ list-style: none; margin: 0; padding: 0; }
            .input-ctn{ position: relative; }
            .address{ width: 300px }
            .autocomplete{position: absolute; left: 0; top: 100%; background-color: #fff;}
            .autocomplete ul{list-style: none; margin: 0; padding: 0;}
            .autocomplete a{white-space: nowrap}
            .pac-container{ box-shadow: none; border: 1px solid #666; }
            .pac-container:after{ display: none; }
        </style>
    </head>

    <body>
        <span class="latlng"></span><br />
        <span class="input-ctn">
            <input type="text" placeholder="address" name="address" class="address" />
            <span class="autocomplete"></span>
        </span><br />

        <a href="#" class="findfood">Search</a> <a href="#" class="random">Random</a>

        <div class="results"><ul></ul></div>
        <!--img src="powered_by_google_on_non_white_hdpi.png" width="144" height="18" alt="powered by Google" /-->

        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <script>
            var appKey = 'AIzaSyAuInzPf6U9VeITNFIxbiTes2rPasEaloA';
            var autocomplete = undefined;
            var accuracy = 0;
            var pos = {
                lat: undefined,
                lng: undefined
            };

            function init(){
                getGeoloc();

                var input = $('.address').get(0);
                autocomplete = new google.maps.places.Autocomplete(input, {
                  location: pos
                });
                autocomplete.addListener('place_changed', function() {
                    var input = $('.address').val();
                    getGeocode(input);
                });

                $('.findfood').on('click', function(e){
                    e.preventDefault();
                    $('.results ul').empty();
                    findFood();
                });

                $('.random').on('click', function(e){
                    e.preventDefault();
                    randomPlace();
                });
            }

            function updateLoc(lat, lng, acc){
                pos.lat = lat;
                pos.lng = lng;
                accuracy = acc;
                $('.latlng').empty().append(pos.lat + ',' + pos.lng + ' (accuracy :'+accuracy+')');

                var options = {
                    center: {
                        lat: lat,
                        lng: lng
                    },
                    radius: acc
                };

                var circle = new google.maps.Circle(options);
                autocomplete.setBounds(circle.getBounds());
            }

            function getGeoloc(){
                if ("geolocation" in navigator) {
                  navigator.geolocation.getCurrentPosition(function(position) {
                    updateLoc(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                  });
                } else {
                  $.ajax({
                      url: "https://www.googleapis.com/geolocation/v1/geolocate?key="+appKey,
                      method: "POST",

                      success: function(data){
                          //console.log(data);

                          var lat = data.location.lat;
                          var lng = data.location.lng;
                          var acc = data.accuracy;

                          updateLoc(lat, lng, acc);
                      }
                  });
                }
            }
            function getGeocode(input){
                geocoder = new google.maps.Geocoder();
                geocoder.geocode( { 'address': input }, function(results, status) {
                    console.log(results[0].geometry.location);
                    if (status == google.maps.GeocoderStatus.OK) {
                        var lat = results[0].geometry.location.lat();
                        var lng = results[0].geometry.location.lng();

                        updateLoc(lat, lng, 0);
                    }
                });
            }
            function findFood(){

                var service = new google.maps.places.PlacesService(document.createElement('div'));
                service.nearbySearch({
                    location: pos,
                    //radius: 1000,
                    //openNow: true,
                    types: ['restaurant'],
                    rankBy : google.maps.places.RankBy.DISTANCE
                }, function(results, status, pagination){
                    console.log(status, pagination, results);

                    $('.results ul').find('.moar').remove();
                    var list = '';
                    $(results).each(function(i,e){
                        var isopen = "";
                        if(e.opening_hours){
                          isopen = " (ferm√©)";

                          if(e.opening_hours.open_now){
                            isopen = " (ouvert)";
                          }
                        }

                        list += '<li data-id="'+e.place_id+'">'+
                        '<label><input type="checkbox" value="'+e.place_id+'" />'+
                        e.name+isopen+' <small>'+e.vicinity+'</small>'+
                        '</label></li>';
                    });
                    if(pagination.hasNextPage)
                        list += '<li class="moar"><a href="#">moar</a></li>';

                    $('.results ul').append(list);
                    $('.moar a').on('click', function() {
                        pagination.nextPage();
                    });
                });
            }

            function randomPlace(){
                var selected = new Array();

                $('.results li').each(function(i,e){
                    if($(e).find('input').is(':checked')){
                        selected.push($(e).text());
                    }
                });

                if(selected.length > 0){
                    var randomIndex = Math.floor(Math.random() * selected.length);
                    $('.results').find('h3').remove();
                    $('.results').prepend('<h3>'+selected[randomIndex]+'</h3>');
                }
            }

        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuInzPf6U9VeITNFIxbiTes2rPasEaloA&libraries=places&callback=init" async defer></script>

        <!-- Help! I'm trapped in a website factory -->
    </body>
</html>
